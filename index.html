<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>วุ้นแปลภาษา T-LIVE-CODE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
     <link href="main.css" rel="stylesheet">
    <style>
        .mic-recording {
            background-color: #ef4444 !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full relative">
        <div class="absolute top-4 left-4  flex items-center space-x-2">
            <img src="tlivecode.png" alt="T-LIVE-CODE" class="w-[100px] h-[100px]">
            <span class="text-xl font-bold text-gray-800">T-LIVE-CODE, แปลภาษา</span>
        </div>
        <div class="flex justify-end mb-4">
            <button id="recordButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-full flex items-center space-x-2 transition duration-300">
                <svg id="micIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                <span id="recordText">เริ่มบันทึก</span>
            </button>
        </div>
        
        <p id="status" class="text-end text-gray-600 mb-4">กด "เริ่มบันทึก" เพื่อเริ่ม</p>
        
        <div class="flex flex-col items-center mb-4 space-y-2">
            <select id="inputLanguage" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="th-TH">ภาษาไทย</option>
                <option value="en-US">ภาษาอังกฤษ</option>
                <option value="ja-JP">ภาษาญี่ปุ่น</option>
                <option value="zh-CN">ภาษาจีน</option>
            </select>
            <textarea id="transcript" class="w-full h-24 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ข้อความที่แปลงจากเสียงหรือพิมพ์ข้อความที่นี่"></textarea>
        </div>
        
        <div class="flex flex-col items-center mb-4 space-y-2">
            <select id="targetLanguage" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">                
                <option value="en">ภาษาอังกฤษ</option>                
                <option value="ja">ภาษาญี่ปุ่น</option>
                <option value="zh">ภาษาจีน</option>
                <option value="th">ภาษาไทย</option>
            </select>
            <select id="voiceSelect" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">เลือกเสียง</option>
            </select>
            <textarea id="translated" class="w-full h-24 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ข้อความที่แปลแล้วจะปรากฏที่นี่"></textarea>
            <textarea id="historyArea" class="w-full h-24 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ประวัติการแปลจะปรากฏที่นี่" readonly></textarea>
        </div>
        
        <p id="translatorStatus" class="text-center text-sm text-gray-500 mb-4">ใช้ Google Translate API หากการแปลล้มเหลว ตรวจสอบคอนโซล</p>
        
        <div class="flex justify-center space-x-4">
            <button id="translateButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">แปล</button>
            <button id="replayButton" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">พูดอีกครั้ง</button>
            <button id="saveXlsx" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">บันทึกเป็น XLSX</button>
        </div>
    </div>

    <script>
        // XLSX Processing Code
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }

        // Speech Recognition Setup
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.interimResults = true;
        recognition.continuous = true;

        const recordButton = document.getElementById('recordButton');
        const recordText = document.getElementById('recordText');
        const micIcon = document.getElementById('micIcon');
        const inputLanguage = document.getElementById('inputLanguage');
        const transcriptArea = document.getElementById('transcript');
        const translatedArea = document.getElementById('translated');
        const historyArea = document.getElementById('historyArea');
        const status = document.getElementById('status');
        const translatorStatus = document.getElementById('translatorStatus');
        const targetLanguage = document.getElementById('targetLanguage');
        const voiceSelect = document.getElementById('voiceSelect');
        const saveXlsxButton = document.getElementById('saveXlsx');
        const replayButton = document.getElementById('replayButton');
        const translateButton = document.getElementById('translateButton');

        let recognizing = false;
        let voices = [];

        // Set initial input language
        recognition.lang = inputLanguage.value;

        // Translation Function
        async function translateText(text, targetLang) {
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }
                const data = await res.json();
                console.log("API Response:", data);
                if (Array.isArray(data) && data[0] && Array.isArray(data[0][0])) {
                    return data[0].map(sentence => sentence[0]).join(" ");
                } else {
                    throw new Error("Unexpected response format");
                }
            } catch (error) {
                console.error("Translation failed:", error.message);
                return "เกิดข้อผิดพลาดในการแปล";
            }
        }

        // Load Voices
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            updateVoiceOptions();
        }

        // Update Voice Options based on Selected Language
        function updateVoiceOptions() {
            const target = targetLanguage.value;
            voiceSelect.innerHTML = '<option value="">เลือกเสียง</option>';
            const langMap = { 'en': 'en-', 'th': 'th-', 'ja': 'ja-', 'zh': 'zh-' };
            const voiceNameMap = {
                'en': 'ภาษาอังกฤษ',
                'th': 'ภาษาไทย',
                'ja': 'ภาษาญี่ปุ่น',
                'zh': 'ภาษาจีน'
            };
            const filteredVoices = voices.filter(voice => voice.lang.toLowerCase().startsWith(langMap[target]));
            filteredVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voiceNameMap[target]} - ${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            if (filteredVoices.length > 0) {
                voiceSelect.value = filteredVoices[0].name; // Default to first voice
            } else {
                voiceSelect.innerHTML += '<option value="" disabled>ไม่มีเสียงสำหรับภาษานี้</option>';
            }
        }

        // Load voices when available
        speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        // Update voices when target language changes
        targetLanguage.addEventListener('change', updateVoiceOptions);

        // Update recognition language when input language changes
        inputLanguage.addEventListener('change', () => {
            recognition.lang = inputLanguage.value;
            if (recognizing) {
                recognition.stop();
                setTimeout(() => recognition.start(), 100); // Restart with new language
            }
        });

        // Toggle Recording
        recordButton.addEventListener('click', () => {
            if (!recognizing) {
                recognition.lang = inputLanguage.value; // Ensure correct input language
                recognition.start();
                recognizing = true;
                recordButton.classList.add('mic-recording');
                recordText.textContent = 'หยุดบันทึก';
                micIcon.classList.add('animate-pulse');
                status.textContent = 'กำลังบันทึก...';
            } else {
                recognition.stop();
                recognizing = false;
                recordButton.classList.remove('mic-recording');
                recordText.textContent = 'เริ่มบันทึก';
                micIcon.classList.remove('animate-pulse');
                status.textContent = 'กำลังประมวลผล...';
            }
        });

        // Handle Recognition Results
        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript = transcript;
                }
            }
            transcriptArea.value = finalTranscript + interimTranscript;
        };

        recognition.onerror = (event) => {
            status.textContent = 'ข้อผิดพลาดในการรู้จำเสียง: ' + event.error;
            recognizing = false;
            recordButton.classList.remove('mic-recording');
            recordText.textContent = 'เริ่มบันทึก';
            micIcon.classList.remove('animate-pulse');
            status.textContent = 'หยุดเนื่องจากข้อผิดพลาด';
        };

        recognition.onend = async () => {
            if (recognizing) {
                recognition.start(); // Restart recognition to keep it continuous
            } else {
                await translateAndSpeak();
            }
        };

        // Translation and Text-to-Speech
        async function translateAndSpeak() {
            const text = transcriptArea.value;
            const target = targetLanguage.value;
            const inputLang = inputLanguage.value.split('-')[0]; // Extract language code (e.g., 'th' from 'th-TH')
            if (!text) {
                status.textContent = 'ไม่มีข้อความให้ประมวลผล';
                return;
            }

            // Translation
            status.textContent = 'กำลังแปล...';
            const translatedText = await translateText(text, target);
            if (translatedText.startsWith("เกิดข้อผิดพลาด")) {
                status.textContent = 'การแปลล้มเหลว';
                translatorStatus.textContent = 'ตรวจสอบคอนโซลสำหรับรายละเอียดข้อผิดพลาด';
                return;
            }
            translatedArea.value = translatedText;
            status.textContent = 'แปลสำเร็จ';

            // Log translation details
            const now = new Date();
            const timestamp = now.toLocaleString('th-TH', { 
                timeZone: 'Asia/Bangkok',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const langNameMap = {
                'th': 'ภาษาไทย',
                'en': 'ภาษาอังกฤษ',
                'ja': 'ภาษาญี่ปุ่น',
                'zh': 'ภาษาจีน'
            };
            console.log(`แปลเมื่อ: ${timestamp}`);
            console.log(`ภาษาที่ป้อน: ${langNameMap[inputLang]}`);
            console.log(`ภาษาเป้าหมาย: ${langNameMap[target]}`);
            console.log(`ข้อความก่อนแปล: ${text}`);
            console.log(`ข้อความหลังแปล: ${translatedText}`);

            // Add to history
            const historyEntry = `[${timestamp}] ภาษาที่ป้อน: ${langNameMap[inputLang]} | ข้อความก่อนแปล: ${text} | ภาษาที่แปล: ${langNameMap[target]} | ข้อความหลังแปล: ${translatedText}\n`;
            historyArea.value += historyEntry;
            const lines = historyArea.value.split('\n');
            if (lines.length > 100) {
                historyArea.value = lines.slice(lines.length - 100).join('\n');
            }
            historyArea.scrollTop = historyArea.scrollHeight; // Auto-scroll to bottom

            // Text-to-Speech
            const selectedVoice = voiceSelect.value;
            if (!selectedVoice) {
                status.textContent = 'ไม่ได้เลือกเสียง';
                return;
            }

            const utterance = new SpeechSynthesisUtterance(translatedText);
            utterance.voice = voices.find(voice => voice.name === selectedVoice);
            utterance.lang = target === 'en' ? 'en-US' : target === 'th' ? 'th-TH' : target === 'ja' ? 'ja-JP' : 'zh-CN';
            utterance.onend = () => {
                status.textContent = 'อ่านข้อความเสร็จสิ้น';
            };
            utterance.onerror = (event) => {
                status.textContent = 'ข้อผิดพลาดในการอ่านข้อความ: ' + event.error;
            };
            window.speechSynthesis.speak(utterance);
            status.textContent = 'กำลังอ่านข้อความ...';
        }

        // Translate Button Click
        translateButton.addEventListener('click', async () => {
            await translateAndSpeak();
        });

        // Replay Text-to-Speech
        replayButton.addEventListener('click', () => {
            const translatedText = translatedArea.value;
            const selectedVoice = voiceSelect.value;
            if (!translatedText) {
                status.textContent = 'ไม่มีข้อความให้อ่าน';
                return;
            }
            if (!selectedVoice) {
                status.textContent = 'ไม่ได้เลือกเสียง';
                return;
            }

            const utterance = new SpeechSynthesisUtterance(translatedText);
            utterance.voice = voices.find(voice => voice.name === selectedVoice);
            utterance.lang = targetLanguage.value === 'en' ? 'en-US' : targetLanguage.value === 'th' ? 'th-TH' : targetLanguage.value === 'ja' ? 'ja-JP' : 'zh-CN';
            utterance.onend = () => {
                status.textContent = 'อ่านข้อความซ้ำเสร็จสิ้น';
            };
            utterance.onerror = (event) => {
                status.textContent = 'ข้อผิดพลาดในการอ่านข้อความ: ' + event.error;
            };
            window.speechSynthesis.speak(utterance);
            status.textContent = 'กำลังอ่านข้อความซ้ำ...';
        });

        // Save History as XLSX
        saveXlsxButton.addEventListener('click', () => {
            const historyText = historyArea.value;
            if (!historyText) {
                status.textContent = 'ไม่มีประวัติการแปลให้บันทึก';
                return;
            }

            // Parse history into data array
            const lines = historyText.split('\n').filter(line => line.trim());
            const data = lines.map(line => {
                const match = line.match(/\[(.+?)\]\s*ภาษาที่ป้อน:\s*(.+?)\s*\|\s*ข้อความก่อนแปล:\s*(.+?)\s*\|\s*ภาษาที่แปล:\s*(.+?)\s*\|\s*ข้อความหลังแปล:\s*(.+)/);
                if (match) {
                    return {
                        'วัน/เวลา': match[1],
                        'ภาษาที่ป้อน': match[2],
                        'ข้อความก่อนแปล': match[3],
                        'ภาษาที่แปล': match[4],
                        'ข้อความที่แปล': match[5]
                    };
                }
                return null;
            }).filter(item => item);

            // Create XLSX
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Translation History');
            const xlsxOutput = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([xlsxOutput], { type: 'application/octet-stream' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'translated_history.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            status.textContent = 'บันทึกเป็น XLSX สำเร็จ';
        });
    </script>
</body>
</html>